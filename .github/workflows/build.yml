name: Build
on: [push, pull_request]
env:
  PARLAY_NUM_THREADS: 16

jobs:
  
  msvc:
    name: Microsoft Visual C++
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ilammy/msvc-dev-cmd@v1
    - name: Configure
      run: |
        md build
        cd build
        cmake -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS_DEBUG=" /bigobj " -DPARLAY_TEST=On ..
        
    - name: Build
      run: |
        cd build
        cmake --build .
        
    - name: Test
      run: |
        cd build
        ctest -C Debug --no-tests=error --output-on-failure

  mingw:
    name: MinGW
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: egor-tensin/setup-mingw@v2
    - name: Configure
      run: |
        md build
        cd build
        cmake -G "MinGW Makefiles" -DCMAKE_CC_COMPILER="cc" -DCMAKE_CXX_COMPILER="c++" -DCMAKE_BUILD_TYPE=Debug -DPARLAY_TEST=On ..
        
    - name: Build
      run: |
        cd build
        cmake --build .
        
    - name: Test
      run: |
        cd build
        ctest -C Debug --no-tests=error --output-on-failure

  wsl-gcc:
    name: WSL GCC
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: Vampire/setup-wsl@v1
    
    - name: Install
      shell: wsl-bash
      run: |
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
        sudo apt-get -qq update
        sudo apt-get -y install gcc-9 g++-9 make
        wget --quiet https://github.com/Kitware/CMake/releases/download/v3.18.2/cmake-3.18.2-Linux-x86_64.tar.gz
        tar -xf cmake-3.18.2-Linux-x86_64.tar.gz
    
    - name: Configure
      shell: wsl-bash
      run: |
        mkdir build
        cd build
        CC=gcc-9 CXX=g++-9 ../cmake-3.18.2-Linux-x86_64/bin/cmake -DCMAKE_BUILD_TYPE=Debug -DPARLAY_TEST=On -DWSL=True ..
        
    - name: Build
      shell: wsl-bash
      run: |
        cd build
        make
        
    - name: Test
      shell: wsl-bash
      run: |
        cd build
        ../cmake-3.18.2-Linux-x86_64/bin/ctest -C Debug --no-tests=error --output-on-failure
